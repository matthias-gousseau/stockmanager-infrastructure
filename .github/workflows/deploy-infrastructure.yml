name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - prod
          - both

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy docker-compose files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.*.yml"
          target: "~/stockmanager/"
          strip_components: 0

      - name: Deploy services
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DB_USER_DEV,DB_PASSWORD_DEV,JWT_SECRET_DEV,DB_USER_PROD,DB_PASSWORD_PROD,JWT_SECRET_PROD,DEPLOY_ENV
        env:
          DB_USER_DEV: ${{ secrets.DB_USER_DEV }}
          DB_PASSWORD_DEV: ${{ secrets.DB_PASSWORD_DEV }}
          JWT_SECRET_DEV: ${{ secrets.JWT_SECRET_DEV }}
          DB_USER_PROD: ${{ secrets.DB_USER_PROD }}
          DB_PASSWORD_PROD: ${{ secrets.DB_PASSWORD_PROD }}
          JWT_SECRET_PROD: ${{ secrets.JWT_SECRET_PROD }}
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
          script: |
            cd stockmanager

            # Exporter les variables d'environnement
            export DB_USER_DEV="${DB_USER_DEV}"
            export DB_PASSWORD_DEV="${DB_PASSWORD_DEV}"
            export JWT_SECRET_DEV="${JWT_SECRET_DEV}"
            export DB_USER_PROD="${DB_USER_PROD}"
            export DB_PASSWORD_PROD="${DB_PASSWORD_PROD}"
            export JWT_SECRET_PROD="${JWT_SECRET_PROD}"

            echo "ðŸš€ DÃ©ploiement de l'infrastructure - Environnement: ${DEPLOY_ENV}"

            if [ "$DEPLOY_ENV" = "dev" ] || [ "$DEPLOY_ENV" = "both" ]; then
              echo "ðŸ“¦ DÃ©ploiement DEV..."
              docker compose -f docker-compose.dev.yml pull
              docker compose -f docker-compose.dev.yml up -d
            fi

            if [ "$DEPLOY_ENV" = "prod" ] || [ "$DEPLOY_ENV" = "both" ]; then
              echo "ðŸ“¦ DÃ©ploiement PROD..."
              docker compose -f docker-compose.prod.yml pull
              docker compose -f docker-compose.prod.yml up -d
            fi

            echo "âœ… DÃ©ploiement terminÃ©"
            docker ps --filter "name=stockmanager" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Deployment summary
        run: |
          echo "### ðŸš€ Infrastructure dÃ©ployÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
